<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Diagnostic Test</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 20px; font-family: monospace; }
        #map { position: absolute; top: 0; bottom: 50%; left: 0; right: 0; }
        #diagnostics { position: absolute; top: 50%; bottom: 0; left: 0; right: 0; padding: 20px; overflow-y: auto; background: #f5f5f5; }
        .test { margin: 10px 0; padding: 10px; background: white; border-radius: 4px; }
        .pass { border-left: 4px solid #4CAF50; }
        .fail { border-left: 4px solid #F44336; }
        .warn { border-left: 4px solid #FF9800; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="diagnostics">
        <h2>Map Diagnostic Tests</h2>
        <div id="results"></div>
    </div>

    <script>
        const results = document.getElementById('results');

        function addTest(name, status, message) {
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.innerHTML = `<strong>${status === 'pass' ? '‚úì' : status === 'fail' ? '‚úó' : '‚ö†'} ${name}</strong><br>${message}`;
            results.appendChild(div);
        }

        // Test 1: MapLibre GL JS loaded
        addTest('MapLibre GL JS',
            typeof maplibregl !== 'undefined' ? 'pass' : 'fail',
            typeof maplibregl !== 'undefined' ? 'Library loaded successfully' : 'Library failed to load');

        // Test 2: Check for config.js
        fetch('/js/config.js')
            .then(response => {
                if (response.ok) {
                    addTest('Config File', 'pass', 'config.js found');
                } else {
                    addTest('Config File', 'warn', 'config.js not found (using defaults)');
                }
            })
            .catch(() => addTest('Config File', 'warn', 'config.js not found (using defaults)'));

        // Test 3: Check server connection
        fetch('/api/info')
            .then(response => response.json())
            .then(data => {
                addTest('Server Connection', 'pass', `Server running: ${data.name}`);
            })
            .catch(error => {
                addTest('Server Connection', 'fail', `Cannot connect to server: ${error.message}`);
            });

        // Test 4: Check AOI data
        fetch('/data/boundaries/williams_treaty_aoi.geojson')
            .then(response => response.json())
            .then(data => {
                addTest('AOI Data', 'pass', `GeoJSON loaded: ${data.features ? data.features.length : 0} features`);
            })
            .catch(error => {
                addTest('AOI Data', 'fail', `Cannot load AOI: ${error.message}`);
            });

        // Test 5: Try to initialize map
        try {
            const testMap = new maplibregl.Map({
                container: 'map',
                style: {
                    version: 8,
                    sources: {
                        osm: {
                            type: 'raster',
                            tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: '&copy; OpenStreetMap Contributors'
                        }
                    },
                    layers: [{
                        id: 'osm',
                        type: 'raster',
                        source: 'osm'
                    }]
                },
                center: [-79.05, 44.3],
                zoom: 9
            });

            testMap.on('load', () => {
                addTest('Map Initialization', 'pass', 'Map loaded successfully');
                addTest('Map Rendering', 'pass', 'Map is rendering tiles');
            });

            testMap.on('error', (e) => {
                addTest('Map Error', 'fail', `Error: ${e.error ? e.error.message : 'Unknown error'}`);
            });

            setTimeout(() => {
                if (testMap.loaded()) {
                    addTest('Map Status (5s)', 'pass', 'Map is loaded and ready');
                } else {
                    addTest('Map Status (5s)', 'warn', 'Map is still loading...');
                }
            }, 5000);

        } catch (error) {
            addTest('Map Initialization', 'fail', `Failed to create map: ${error.message}`);
        }

        // Log to console
        console.log('üîç Running diagnostic tests...');
        console.log('Check this page for results');
    </script>
</body>
</html>
